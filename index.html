<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å</title>
    <link
      rel="icon" 
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåæ</text></svg>"
    />
    <script src="https://unpkg.com/@supabase/supabase-js@2.78.0/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #007bff;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        background-color: var(--light-color);
        color: var(--dark-color);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      h1,
      h2,
      h3 {
        color: var(--dark-color);
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .btn {
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out,
          border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        cursor: pointer;
        text-decoration: none;
      }

      .btn-primary {
        color: #fff;
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }
      .btn-secondary {
        color: #fff;
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
      }
      .btn-success {
        color: #fff;
        background-color: var(--success-color);
        border-color: var(--success-color);
      }
      .btn-danger {
        color: #fff;
        background-color: var(--danger-color);
        border-color: var(--danger-color);
      }
      .btn-warning {
        color: #212529;
        background-color: var(--warning-color);
        border-color: var(--warning-color);
      }
      .btn-info {
        color: #fff;
        background-color: var(--info-color);
        border-color: var(--info-color);
      }
      .btn-light {
        color: #212529;
        background-color: var(--light-color);
        border-color: var(--light-color);
      }
      .btn-dark {
        color: #fff;
        background-color: var(--dark-color);
        border-color: var(--dark-color);
      }

      .btn:hover {
        opacity: 0.85;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-control {
        display: block;
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      /* Page 0: Login */
      #login-form {
        max-width: 400px;
        margin: 50px auto;
        text-align: center;
      }

      /* Page 1: Dashboard */
      .dryer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .dryer-button {
        padding: 30px;
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .dryer-button:hover {
        transform: scale(1.05);
      }
      .status-idle {
        background-color: var(--secondary-color);
      }
      .status-filling {
        background-color: var(--info-color);
      }
      .status-drying {
        background-color: var(--warning-color);
        color: var(--dark-color);
      }
      .status-cooling {
        background-color: var(--primary-color);
      }
      .status-completed {
        background-color: var(--success-color);
      }

      /* Page 2: Control Panel */
      .records-list {
        list-style: none;
        padding: 0;
      }
      .record-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .record-item button {
        margin-left: 10px;
      }

      /* Page 3: History */
      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .filters .form-group {
        margin-bottom: 0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: var(--light-color);
      }
      tr:hover {
        background-color: #f5f5f5;
      }
      .pagination {
        display: flex;
        justify-content: center;
        list-style: none;
        padding: 0;
      }
      .pagination li {
        margin: 0 5px;
      }

      /* Popup */
      #popup-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      #popup-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .popup-add {
        background-color: #d4edda;
      }
      .popup-edit {
        background-color: #fff3cd;
      }
      .popup-delete {
        background-color: #f8d7da;
      }
      .popup-actions {
        margin-top: 20px;
        text-align: right;
      }
      .popup-actions button {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Page 0: Login -->
    <div id="page-0" class="page active">
      <div class="container">
        <div class="card">
          <form id="login-form">
            <h1>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
            <div class="form-group">
              <label for="pin-input">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ PIN</label>
              <input
                type="password"
                id="pin-input"
                class="form-control"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Page 1: Dashboard -->
    <div id="page-1" class="page">
      <div class="container">
        <div class="card">
          <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
          <button
            id="btn-logout"
            class="btn btn-secondary"
            style="float: right"
          >
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
          <button id="btn-view-history" class="btn btn-info">
            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
          </button>
          <button id="btn-refresh-dashboard" class="btn btn-dark">
            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </button>
          <div style="clear: both; margin-top: 20px"></div>
          <div id="dryer-status-container" class="dryer-grid">
            <!-- Dryer buttons will be generated here by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Page 2: Dryer Control Panel -->
    <div id="page-2" class="page">
      <div class="container">
        <div class="card">
          <button id="btn-back-to-dashboard" class="btn btn-secondary">
            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
          </button>
          <h2>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å</h2>
          <p>
            <strong>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà:</strong> <span id="control-dryer-id">-</span>
          </p>
          <p>
            <strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ö:</strong>
            <span id="control-batch-number">-</span>
          </p>
          <hr />
          <div id="action-buttons-container">
            <!-- Action buttons will be generated here by JS -->
          </div>
          <hr />
          <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ö</h3>
          <ul id="records-list" class="records-list">
            <!-- Records will be listed here by JS -->
          </ul>
          <button id="btn-add-record" class="btn btn-success">
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
          <hr />
          <h3>‡∏Å‡∏£‡∏≤‡∏ü</h3>
          <div style="position: relative; height: 400px; width: 100%">
            <canvas id="moisture-chart"></canvas>
          </div>
          <div
            style="
              position: relative;
              height: 400px;
              width: 100%;
              margin-top: 20px;
            "
          >
            <canvas id="temperature-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 3: History -->
    <div id="page-3" class="page">
      <div class="container">
        <div class="card">
          <button
            id="btn-back-to-dashboard-from-history"
            class="btn btn-secondary"
          >
            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
          </button>
          <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h2>
          <div id="history-summary">
            <!-- Summary will be shown here -->
          </div>
          <div class="filters">
            <div class="form-group">
              <label for="filter-dryer">‡∏´‡∏±‡∏ß‡∏≠‡∏ö</label>
              <select id="filter-dryer" class="form-control">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="1">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 1</option>
                <option value="2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 2</option>
                <option value="3">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 3</option>
                <option value="4">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 4</option>
                <option value="5">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 5</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filter-rice-type">‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏ß</label>
              <input type="text" id="filter-rice-type" class="form-control" />
            </div>
            <div class="form-group">
              <label for="filter-storage">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</label>
              <input type="text" id="filter-storage" class="form-control" />
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button id="btn-apply-filters" class="btn btn-primary">
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ö</th>
                <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà</th>
                <th>‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏ß</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th>
                <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≤‡∏ß</th>
                <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ö</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
              <!-- Table rows will be generated here by JS -->
            </tbody>
          </table>
          <ul id="history-pagination" class="pagination">
            <!-- Pagination will be generated here by JS -->
          </ul>
        </div>
      </div>
    </div>

    <!-- Generic Popup -->
    <div id="popup-backdrop">
      <div id="popup-container">
        <h3 id="popup-title"></h3>
        <div id="popup-content"></div>
      </div>
    </div>

    <script>
      // ========================================
      // CONFIGURATION & INITIALIZATION
      // ========================================
      console.log("SYSTEM: Starting application initialization...");

      const SUPABASE_URL = "https://xxbaegxsavaemekstxso.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4YmFlZ3hzYXZhZW1la3N0eHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDgwNjEsImV4cCI6MjA3NzYyNDA2MX0.TY7OGsMvmxbthfmwoJOuIzAdOYS87YZ-oHbCVgpryL4";
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å client.createClient ‡πÄ‡∏õ‡πá‡∏ô supabase.createClient ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏õ‡πá‡∏ô supabaseClient
      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const MANAGER_PIN = "9511";
      const STAFF_PIN = "1357";
      const ACTION_CONFIRM_PIN = "1234";

      const DRYER_COUNT = 5;
      const HISTORY_PAGE_SIZE = 10;

      let appState = {
        currentUser: { role: null, pin: null },
        currentDryerId: null,
        currentBatch: null,
        currentRecords: [],
        historyPage: 1,
        historyTotalPages: 1,
        historyFilters: { dryer: "", riceType: "", storage: "" },
      };

      let moistureChart = null;
      let temperatureChart = null;

      // ========================================
      // PWA SETUP
      // ========================================
      async function registerServiceWorker() {
        console.log("PWA: Attempting to register service worker...");
        if ("serviceWorker" in navigator) {
          const swCode = `
                const CACHE_NAME = 'paddy-dryer-pwa-v1';
                const urlsToCache = [
                    '/',
                    'https://cdn.jsdelivr.net/npm/supabase-js@2',
                    'https://cdn.jsdelivr.net/npm/chart.js'
                ];

                self.addEventListener('install', event => {
                    console.log('SW: Install event');
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', event => {
                    console.log('SW: Fetch event for ', event.request.url);
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                // Cache hit - return response
                                if (response) {
                                    console.log('SW: Found in cache');
                                    return response;
                                }
                                console.log('SW: Not in cache, fetching from network');
                                return fetch(event.request);
                            })
                    );
                });
            `;
          const blob = new Blob([swCode], { type: "application/javascript" });
          const swUrl = URL.createObjectURL(blob);
          try {
            const registration = await navigator.serviceWorker.register(swUrl);
            console.log(
              "PWA: Service Worker registered with scope:",
              registration.scope
            );
          } catch (error) {
            console.error("PWA: Service Worker registration failed:", error);
          }
        } else {
          console.log("PWA: Service Workers are not supported.");
        }
      }

      async function registerWebAppManifest() {
        console.log("PWA: Attempting to register web app manifest...");
        const manifestContent = {
          name: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å",
          short_name: "DryerApp",
          start_url: "/",
          display: "standalone",
          background_color: "#ffffff",
          description: "PWA for recording paddy rice drying process.",
          icons: [
            {
              src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåæ</text></svg>",
              sizes: "any",
              type: "image/svg+xml",
            },
          ],
        };
        const blob = new Blob([JSON.stringify(manifestContent)], {
          type: "application/json",
        });
        const manifestUrl = URL.createObjectURL(blob);
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = manifestUrl;
        document.head.appendChild(link);
        console.log("PWA: Manifest link added to head.");
      }

      // ========================================
      // UTILITY FUNCTIONS
      // ========================================
      function showPage(pageId) {
        console.log(`UI: Navigating to page ${pageId}`);
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(`page-${pageId}`).classList.add("active");
      }

      function showPopup(title, contentHtml, className = "") {
        console.log(`UI: Showing popup: ${title}`);
        const backdrop = document.getElementById("popup-backdrop");
        const container = document.getElementById("popup-container");
        document.getElementById("popup-title").innerText = title;
        document.getElementById("popup-content").innerHTML = contentHtml;
        container.className = className;
        backdrop.style.display = "flex";
      }

      function closePopup() {
        console.log("UI: Closing popup");
        document.getElementById("popup-backdrop").style.display = "none";
      }

      function formatThaiDateTime(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleString("th-TH", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function calculateElapsedTime(startTime) {
        if (!startTime) return "-";
        const now = new Date();
        const start = new Date(startTime);
        const diffMs = now - start;
        const diffHrs = Math.floor(diffMs / 3600000);
        const diffMins = Math.floor((diffMs % 3600000) / 60000);
        if (diffHrs > 0) return `${diffHrs} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        return `${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
      }

      function showError(message) {
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${message}`);
        console.error("UI Error Displayed:", message);
      }

      // ========================================
      // AUTHENTICATION
      // ========================================
      async function handleLogin(event) {
        event.preventDefault();
        const pin = document.getElementById("pin-input").value;
        console.log(`AUTH: Login attempt with PIN: ${pin}`);

        if (pin === MANAGER_PIN) {
          appState.currentUser = { role: "manager", pin: pin };
          console.log("AUTH: Login successful as MANAGER");
          showPage(1);
          renderDashboard();
        } else if (pin === STAFF_PIN) {
          appState.currentUser = { role: "staff", pin: pin };
          console.log("AUTH: Login successful as STAFF");
          showPage(1);
          renderDashboard();
        } else {
          console.log("AUTH: Login failed, invalid PIN");
          showError("‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
      }

      function handleLogout() {
        console.log(`AUTH: Logging out user ${appState.currentUser.role}`);
        appState.currentUser = { role: null, pin: null };
        document.getElementById("pin-input").value = "";
        showPage(0);
      }

      // <<<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ >>>>>
      function calculateDuration(startTime, endTime) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!startTime || !endTime) {
          return "-";
        }
        const start = new Date(startTime);
        const end = new Date(endTime);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
          return "-";
        }

        const diffMs = end - start;
        if (diffMs < 0) {
          return "-"; // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        }

        const diffHrs = Math.floor(diffMs / 3600000);
        const diffMins = Math.floor((diffMs % 3600000) / 60000);

        if (diffHrs > 0) {
          return `${diffHrs} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        return `${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
      }

      // ========================================
      // API CALLS TO SUPABASE
      // ========================================
      async function fetchDryerStatus(dryerId) {
        console.log(`API: Fetching status for dryer ${dryerId}`);
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        const { data, error } = await supabaseClient
          .from("drying_batches")
          .select("*")
          .eq("dryer_id", dryerId)
          .neq("status", "completed")
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle(); // Use maybeSingle to handle no rows gracefully

        if (error) {
          console.error("API Error fetching dryer status:", error);
          return null;
        }
        console.log(`API: Dryer ${dryerId} status response:`, data);
        return data;
      }

      async function fetchAllDryersStatus() {
        console.log("API: Fetching status for all dryers");
        const promises = [];
        for (let i = 1; i <= DRYER_COUNT; i++) {
          promises.push(fetchDryerStatus(i));
        }
        const results = await Promise.all(promises);
        console.log("API: All dryer statuses fetched:", results);
        return results;
      }

      async function updateBatchStatus(batchId, updates) {
        console.log(`API: Updating batch ${batchId} with:`, updates);
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        const { data, error } = await supabaseClient
          .from("drying_batches")
          .update(updates)
          .eq("id", batchId)
          .select()
          .single();

        if (error) {
          console.error("API Error updating batch:", error);
          throw error;
        }
        console.log("API: Batch update successful:", data);
        return data;
      }

      async function createNewBatch(dryerId, batchNumber, riceType) {
        console.log(`API: Creating new batch for dryer ${dryerId}`);
        const newBatch = {
          dryer_id: dryerId,
          batch_number: batchNumber,
          rice_type: riceType,
          status: "filling",
          start_filling_time: new Date().toISOString(),
        };
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        const { data, error } = await supabaseClient
          .from("drying_batches")
          .insert(newBatch)
          .select()
          .single();

        if (error) {
          console.error("API Error creating batch:", error);
          throw error;
        }
        console.log("API: New batch created:", data);
        return data;
      }

      async function fetchRecordsForBatch(batchId) {
        console.log(`API: Fetching records for batch ${batchId}`);
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        const { data, error } = await supabaseClient
          .from("drying_records")
          .select("*")
          .eq("batch_id", batchId)
          .order("record_time", { ascending: true });

        if (error) {
          console.error("API Error fetching records:", error);
          return [];
        }
        console.log(`API: Records for batch ${batchId}:`, data);
        return data;
      }

      async function addRecordForBatch(batchId, record) {
        console.log(`API: Adding record for batch ${batchId}:`, record);
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        const { data, error } = await supabaseClient
          .from("drying_records")
          .insert({ ...record, batch_id: batchId })
          .select()
          .single();

        if (error) {
          console.error("API Error adding record:", error);
          throw error;
        }
        console.log("API: Record added successfully:", data);
        return data;
      }

      async function updateRecord(recordId, updates) {
        console.log(`API: Updating record ${recordId} with:`, updates);
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        const { data, error } = await supabaseClient
          .from("drying_records")
          .update(updates)
          .eq("id", recordId)
          .select()
          .single();

        if (error) {
          console.error("API Error updating record:", error);
          throw error;
        }
        console.log("API: Record updated successfully:", data);
        return data;
      }

      async function deleteRecord(recordId) {
        console.log(`API: Deleting record ${recordId}`);
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        const { error } = await supabaseClient
          .from("drying_records")
          .delete()
          .eq("id", recordId);

        if (error) {
          console.error("API Error deleting record:", error);
          throw error;
        }
        console.log(`API: Record ${recordId} deleted successfully.`);
      }

      async function fetchCompletedBatches(page, filters) {
        console.log(
          `API: Fetching completed batches. Page: ${page}, Filters:`,
          filters
        );
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å supabase ‡πÄ‡∏õ‡πá‡∏ô supabaseClient
        let query = supabaseClient
          .from("drying_batches")
          .select("*", { count: "exact" })
          .eq("status", "completed")
          .order("completed_time", { ascending: false })
          .range((page - 1) * HISTORY_PAGE_SIZE, page * HISTORY_PAGE_SIZE - 1);

        if (filters.dryer)
          query = query.eq("dryer_id", parseInt(filters.dryer));
        if (filters.riceType)
          query = query.ilike("rice_type", `%${filters.riceType}%`);
        if (filters.storage)
          query = query.ilike("storage_location", `%${filters.storage}%`);

        const { data, error, count } = await query;

        if (error) {
          console.error("API Error fetching completed batches:", error);
          return { batches: [], totalPages: 0 };
        }

        const totalPages = Math.ceil(count / HISTORY_PAGE_SIZE);
        console.log(
          `API: Completed batches fetched. Count: ${count}, TotalPages: ${totalPages}`,
          data
        );
        return { batches: data, totalPages };
      }

      // ========================================
      // UI RENDERING FUNCTIONS
      // ========================================
      function renderDashboard() {
        console.log("UI: Rendering dashboard");
        const container = document.getElementById("dryer-status-container");
        container.innerHTML = "";
        fetchAllDryersStatus().then((statuses) => {
          statuses.forEach((batch, index) => {
            const dryerId = index + 1;
            const status = batch ? batch.status : "idle";
            const elapsedTime =
              batch && batch.start_filling_time
                ? calculateElapsedTime(batch.start_filling_time)
                : "";
            const statusText = {
              idle: "‡∏ß‡πà‡∏≤‡∏á",
              filling: `‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≤‡∏ß‡∏≠‡∏¢‡∏π‡πà (${elapsedTime})`,
              drying: `‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡∏≠‡∏¢‡∏π‡πà (${elapsedTime})`,
              cooling: `‡∏≠‡∏ö‡∏≠‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà (${elapsedTime})`,
              completed: "‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",
            }[status];

            const button = document.createElement("div");
            button.className = `dryer-button status-${status}`;
            button.innerHTML = `
                    <div>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${dryerId}</div>
                    <div style="font-size: 0.9em; margin-top: 5px;">${statusText}</div>
                `;
            button.onclick = () => openControlPanel(dryerId);
            container.appendChild(button);
          });
        });
      }

      function openControlPanel(dryerId) {
        console.log(`UI: Opening control panel for dryer ${dryerId}`);
        appState.currentDryerId = dryerId;
        showPage(2);
        renderControlPanel();
      }

      function renderControlPanel() {
        console.log(
          `UI: Rendering control panel for dryer ${appState.currentDryerId}`
        );
        document.getElementById("control-dryer-id").innerText =
          appState.currentDryerId;

        fetchDryerStatus(appState.currentDryerId)
          .then((batch) => {
            appState.currentBatch = batch;
            document.getElementById("control-batch-number").innerText = batch
              ? batch.batch_number
              : "-";
            renderActionButtons(batch);

            // <<<< ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ >>>>
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• batch ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÑ‡∏õ‡∏î‡∏∂‡∏á records
            if (batch) {
              // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ batch ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• records ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
              return fetchRecordsForBatch(batch.id);
            } else {
              // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ batch (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô array ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
              console.log("UI: Dryer is idle, no records to fetch.");
              appState.currentRecords = [];
              renderRecordsList([]); // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á
              renderGraphs([]); // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡πà‡∏≤‡∏á
              return Promise.resolve([]); // ‡∏™‡πà‡∏á Promise ‡∏ó‡∏µ‡πà resolve ‡∏Ñ‡πà‡∏≤ array ‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
            }
          })
          .then((records) => {
            // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ batch ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (records) {
              appState.currentRecords = records;
              renderRecordsList(records);
              renderGraphs(records);
            }
          });
      }

      function renderActionButtons(batch) {
        console.log(
          "UI: Rendering action buttons for status:",
          batch ? batch.status : "idle"
        );
        const container = document.getElementById("action-buttons-container");
        container.innerHTML = "";
        if (appState.currentUser.role !== "staff") {
          container.innerHTML =
            '<p style="color: var(--secondary-color);">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Manager ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>';
          return;
        }

        // <<<< ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç >>>>
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ batch ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 'idle'
        const status = batch ? batch.status : "idle";
        let buttonHtml = "";

        if (status === "idle") {
          // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≤‡∏ß
          buttonHtml = `<button class="btn btn-info" onclick="handleStartFilling()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≤‡∏ß</button>`;
        } else if (status === "filling") {
          buttonHtml = `<button class="btn btn-warning" onclick="handleStartDrying()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß</button>`;
        } else if (status === "drying") {
          buttonHtml = `<button class="btn btn-primary" onclick="handleStartCooling()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏≠‡∏≠‡∏Å</button>`;
        } else if (status === "cooling") {
          buttonHtml = `<button class="btn btn-success" onclick="handleMarkCompleted()">‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>`;
        }
        container.innerHTML = buttonHtml;
      }

      function renderRecordsList(records) {
        console.log("UI: Rendering records list");
        const list = document.getElementById("records-list");
        list.innerHTML = "";
        if (records.length === 0) {
          list.innerHTML = "<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>";
          return;
        }
        records.forEach((record) => {
          const li = document.createElement("li");
          li.className = "record-item";
          li.innerHTML = `
                <span>${formatThaiDateTime(record.record_time)} | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: ${
            record.humidity
          }% | ‡∏≠‡∏∏‡∏ì‡∏Ø ‡∏ö‡∏ô: ${record.temperature_top}¬∞C | ‡∏≠‡∏∏‡∏ì‡∏Ø ‡∏•‡πà‡∏≤‡∏á: ${
            record.temperature_bottom
          }¬∞C</span>
                <div>
                    ${
                      appState.currentUser.role === "staff"
                        ? `<button class="btn btn-warning btn-sm" onclick="handleEditRecord(${record.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`
                        : ""
                    }
                    ${
                      appState.currentUser.role === "staff"
                        ? `<button class="btn btn-danger btn-sm" onclick="handleDeleteRecord(${record.id})">‡∏•‡∏ö</button>`
                        : ""
                    }
                </div>
            `;
          list.appendChild(li);
        });
      }

      function renderGraphs(records) {
        console.log("UI: Rendering graphs");
        const labels = records.map((r) => formatThaiDateTime(r.record_time));
        const moistureData = records.map((r) => r.humidity);
        const tempTopData = records.map((r) => r.temperature_top);
        const tempBottomData = records.map((r) => r.temperature_bottom);

        // Destroy old charts if they exist
        if (moistureChart) moistureChart.destroy();
        if (temperatureChart) temperatureChart.destroy();

        // Moisture Chart
        const moistureCtx = document
          .getElementById("moisture-chart")
          .getContext("2d");
        moistureChart = new Chart(moistureCtx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)",
                data: moistureData,
                borderColor: "rgb(75, 192, 192)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 35,
                ticks: { stepSize: 5 },
                grid: {
                  color: (context) =>
                    context.tick.value === 13.5 ? "red" : "rgba(0,0,0,0.1)",
                },
              },
            },
          },
        });

        // Temperature Chart
        const tempCtx = document
          .getElementById("temperature-chart")
          .getContext("2d");
        temperatureChart = new Chart(tempCtx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ö‡∏ô (¬∞C)",
                data: tempTopData,
                borderColor: "rgb(255, 99, 132)",
                tension: 0.1,
              },
              {
                label: "‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏•‡πà‡∏≤‡∏á (¬∞C)",
                data: tempBottomData,
                borderColor: "rgb(54, 162, 235)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                min: 35,
                max: 50,
                ticks: { stepSize: 5 },
              },
            },
          },
        });
      }

      function renderHistory() {
        console.log("UI: Rendering history page");
        fetchCompletedBatches(
          appState.historyPage,
          appState.historyFilters
        ).then(({ batches, totalPages }) => {
          appState.historyTotalPages = totalPages;
          renderHistoryTable(batches);
          renderHistoryPagination();
        });
      }

      function renderHistoryTable(batches) {
        console.log("UI: Rendering history table");
        const tbody = document.getElementById("history-table-body");
        tbody.innerHTML = "";
        batches.forEach((batch) => {
          // <<<< ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ >>>>>
          const fillingDuration = calculateDuration(
            batch.start_filling_time,
            batch.start_drying_time
          );
          const dryingDuration = calculateDuration(
            batch.start_drying_time,
            batch.completed_time
          );

          const tr = document.createElement("tr");
          tr.style.cursor = "pointer";
          tr.innerHTML = `
                <td>${batch.batch_number}</td>
                <td>${batch.dryer_id}</td>
                <td>${batch.rice_type}</td>
                <td>${formatThaiDateTime(batch.start_drying_time)}</td>
                <td>${formatThaiDateTime(batch.completed_time)}</td>
                <td>${batch.storage_location}</td>
                <td>${fillingDuration}</td>
                <td>${dryingDuration}</td>
            `;
          tr.onclick = () => showHistoryDetail(batch);
          tbody.appendChild(tr);
        });
      }

      function renderHistoryPagination() {
        console.log(
          `UI: Rendering pagination for page ${appState.historyPage}/${appState.historyTotalPages}`
        );
        const pagination = document.getElementById("history-pagination");
        pagination.innerHTML = "";

        if (appState.historyPage > 1) {
          const prevLi = document.createElement("li");
          prevLi.innerHTML = `<button class="btn btn-secondary" onclick="goToHistoryPage(${
            appState.historyPage - 1
          })">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>`;
          pagination.appendChild(prevLi);
        }

        const pageSpan = document.createElement("span");
        pageSpan.style.margin = "0 15px";
        pageSpan.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${appState.historyPage} ‡∏à‡∏≤‡∏Å ${appState.historyTotalPages}`;
        pagination.appendChild(pageSpan);

        if (appState.historyPage < appState.historyTotalPages) {
          const nextLi = document.createElement("li");
          nextLi.innerHTML = `<button class="btn btn-secondary" onclick="goToHistoryPage(${
            appState.historyPage + 1
          })">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>`;
          pagination.appendChild(nextLi);
        }
      }

      function showHistoryDetail(batch) {
        console.log("UI: Showing detail for batch:", batch);
        fetchRecordsForBatch(batch.id).then((records) => {
          const detailHtml = `
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ö:</strong> ${batch.batch_number}</p>
                <p><strong>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà:</strong> ${batch.dryer_id}</p>
                <p><strong>‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏ß:</strong> ${batch.rice_type}</p>
                <p><strong>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≤‡∏ß:</strong> ${formatThaiDateTime(
                  batch.start_filling_time
                )}</p>
                <p><strong>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß:</strong> ${formatThaiDateTime(
                  batch.start_drying_time
                )}</p>
                <p><strong>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏≠‡∏≠‡∏Å:</strong> ${formatThaiDateTime(
                  batch.start_cooling_time
                )}</p>
                <p><strong>‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${formatThaiDateTime(
                  batch.completed_time
                )}</p>
                <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö:</strong> ${batch.storage_location}</p>
                <hr>
                <h4>‡∏Å‡∏£‡∏≤‡∏ü</h4>
                <div style="position: relative; height:300px; width:100%"><canvas id="detail-moisture-chart"></canvas></div>
                <div style="position: relative; height:300px; width:100%; margin-top:20px;"><canvas id="detail-temp-chart"></canvas></div>
            `;
          showPopup(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö: ${batch.batch_number}`, detailHtml);

          // Render charts in popup
          setTimeout(() => {
            const labels = records.map((r) =>
              formatThaiDateTime(r.record_time)
            );
            const moistureData = records.map((r) => r.humidity);
            const tempTopData = records.map((r) => r.temperature_top);
            const tempBottomData = records.map((r) => r.temperature_bottom);

            new Chart(
              document.getElementById("detail-moisture-chart").getContext("2d"),
              {
                type: "line",
                data: {
                  labels,
                  datasets: [
                    {
                      label: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)",
                      data: moistureData,
                      borderColor: "rgb(75, 192, 192)",
                      tension: 0.1,
                    },
                  ],
                },
                options: {
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 35,
                      ticks: { stepSize: 5 },
                      grid: {
                        color: (context) =>
                          context.tick.value === 13.5
                            ? "red"
                            : "rgba(0,0,0,0.1)",
                      },
                    },
                  },
                },
              }
            );
            new Chart(
              document.getElementById("detail-temp-chart").getContext("2d"),
              {
                type: "line",
                data: {
                  labels,
                  datasets: [
                    {
                      label: "‡∏≠‡∏∏‡∏ì‡∏Ø ‡∏ö‡∏ô (¬∞C)",
                      data: tempTopData,
                      borderColor: "rgb(255, 99, 132)",
                      tension: 0.1,
                    },
                    {
                      label: "‡∏≠‡∏∏‡∏ì‡∏Ø ‡∏•‡πà‡∏≤‡∏á (¬∞C)",
                      data: tempBottomData,
                      borderColor: "rgb(54, 162, 235)",
                      tension: 0.1,
                    },
                  ],
                },
                options: {
                  scales: { y: { min: 35, max: 50, ticks: { stepSize: 5 } } },
                },
              }
            );
          }, 100);
        });
      }

      // ========================================
      // ACTION HANDLERS (POPUPS)
      // ========================================
      function handleStartFilling() {
        console.log("ACTION: Start Filling");
        const content = `
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏≠‡∏ö</label><input class="form-control" value="${
              appState.currentDryerId
            }" disabled></div>
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</label><input class="form-control" value="${formatThaiDateTime(
              new Date()
            )}" disabled></div>
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ö</label><input id="popup-batch-number" class="form-control" required></div>
            <div class="form-group"><label>‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏ß</label>
                <select id="popup-rice-type" class="form-control" required>
                    <option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏ß...</option>
                    <option value="‡∏Å‡∏Ç15">‡∏Å‡∏Ç15</option>
                    <option value="‡∏°‡∏∞‡∏•‡∏¥105">‡∏°‡∏∞‡∏•‡∏¥105</option>
                    <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
            </div>
            <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label><input id="popup-confirm-pin" type="password" class="form-control" required></div>
            <div class="popup-actions">
                <button class="btn btn-primary" onclick="confirmStartFilling()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        showPopup("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≤‡∏ß", content);
      }

      async function confirmStartFilling() {
        const batchNumber = document.getElementById("popup-batch-number").value;
        const riceType = document.getElementById("popup-rice-type").value;
        const pin = document.getElementById("popup-confirm-pin").value;

        // <<<< ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö >>>>>
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!batchNumber || batchNumber.trim() === "") {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ö");
          return;
        }
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!riceType) {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏ß");
          return;
        }

        if (pin !== ACTION_CONFIRM_PIN) {
          showError("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }
        try {
          await createNewBatch(appState.currentDryerId, batchNumber, riceType);
          closePopup();
          renderControlPanel();
        } catch (error) {
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function handleStartDrying() {
        console.log("ACTION: Start Drying");
        const content = `
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏≠‡∏ö</label><input class="form-control" value="${
              appState.currentDryerId
            }" disabled></div>
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</label><input class="form-control" value="${formatThaiDateTime(
              new Date()
            )}" disabled></div>
            <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label><input id="popup-confirm-pin" type="password" class="form-control" required></div>
            <div class="popup-actions">
                <button class="btn btn-primary" onclick="confirmStartDrying()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        showPopup("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß", content);
      }

      async function confirmStartDrying() {
        const pin = document.getElementById("popup-confirm-pin").value;
        if (pin !== ACTION_CONFIRM_PIN) {
          showError("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }
        try {
          await updateBatchStatus(appState.currentBatch.id, {
            status: "drying",
            start_drying_time: new Date().toISOString(),
          });
          closePopup();
          renderControlPanel();
        } catch (error) {
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function handleStartCooling() {
        console.log("ACTION: Start Cooling");
        const content = `
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏≠‡∏ö</label><input class="form-control" value="${
              appState.currentDryerId
            }" disabled></div>
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</label><input class="form-control" value="${formatThaiDateTime(
              new Date()
            )}" disabled></div>
            <div class="form-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</label>
                <select id="popup-storage-location" class="form-control" required>
                    <option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...</option>
                    <option value="‡∏´‡πâ‡∏≠‡∏á1">‡∏´‡πâ‡∏≠‡∏á1</option>
                    <option value="‡∏´‡πâ‡∏≠‡∏á2">‡∏´‡πâ‡∏≠‡∏á2</option>
                    <option value="‡∏´‡πâ‡∏≠‡∏á3">‡∏´‡πâ‡∏≠‡∏á3</option>
                    <option value="‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏°">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏°</option>
                </select>
            </div>
            <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label><input id="popup-confirm-pin" type="password" class="form-control" required></div>
            <div class="popup-actions">
                <button class="btn btn-primary" onclick="confirmStartCooling()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        showPopup("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏≠‡∏≠‡∏Å", content);
      }

      async function confirmStartCooling() {
        const storageLocation = document.getElementById(
          "popup-storage-location"
        ).value;
        const pin = document.getElementById("popup-confirm-pin").value;

        // <<<< ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô) >>>>>
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)
        if (!storageLocation) {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"); // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        }

        if (pin !== ACTION_CONFIRM_PIN) {
          showError("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }

        try {
          await updateBatchStatus(appState.currentBatch.id, {
            status: "cooling",
            start_cooling_time: new Date().toISOString(),
            storage_location: storageLocation,
          });
          closePopup();
          renderControlPanel();
        } catch (error) {
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function handleMarkCompleted() {
        console.log("ACTION: Mark Completed");
        const content = `
            <div class="form-group"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏≠‡∏ö</label><input class="form-control" value="${
              appState.currentDryerId
            }" disabled></div>
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</label><input class="form-control" value="${formatThaiDateTime(
              new Date()
            )}" disabled></div>
            <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label><input id="popup-confirm-pin" type="password" class="form-control" required></div>
            <div class="popup-actions">
                <button class="btn btn-primary" onclick="confirmMarkCompleted()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        showPopup("‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß", content);
      }

      async function confirmMarkCompleted() {
        const pin = document.getElementById("popup-confirm-pin").value;
        if (pin !== ACTION_CONFIRM_PIN) {
          showError("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }
        try {
          await updateBatchStatus(appState.currentBatch.id, {
            status: "completed",
            completed_time: new Date().toISOString(),
          });
          closePopup();
          renderControlPanel();
        } catch (error) {
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function handleAddRecord() {
        console.log("ACTION: Add Record");
        const content = `
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</label><input class="form-control" value="${formatThaiDateTime(
              new Date()
            )}" disabled></div>
            <div class="form-group"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</label><input id="popup-humidity" type="number" step="0.01" class="form-control" required></div>
            <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ö‡∏ô (¬∞C)</label><input id="popup-temp-top" type="number" step="0.01" class="form-control" required></div>
            <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏•‡πà‡∏≤‡∏á (¬∞C)</label><input id="popup-temp-bottom" type="number" step="0.01" class="form-control" required></div>
            <div class="popup-actions">
                <button class="btn btn-success" onclick="confirmAddRecord()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        showPopup("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", content, "popup-add");
      }

      async function confirmAddRecord() {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input fields ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö string
        const humidityStr = document.getElementById("popup-humidity").value;
        const tempTopStr = document.getElementById("popup-temp-top").value;
        const tempBottomStr =
          document.getElementById("popup-temp-bottom").value;

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ string ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        const humidity = parseFloat(humidityStr);
        const tempTop = parseFloat(tempTopStr);
        const tempBottom = parseFloat(tempBottomStr);

        // <<<< ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö >>>>>
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
        if (humidityStr.trim() === "" || isNaN(humidity)) {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç");
          return;
        }
        if (humidity < 1 || humidity > 35) {
          showError("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 1 ‡∏ñ‡∏∂‡∏á 35");
          return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ö‡∏ô
        if (tempTopStr.trim() === "" || isNaN(tempTop)) {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç");
          return;
        }
        if (tempTop < 0 || tempTop > 50) {
          showError("‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ö‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0 ‡∏ñ‡∏∂‡∏á 50");
          return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏•‡πà‡∏≤‡∏á
        if (tempBottomStr.trim() === "" || isNaN(tempBottom)) {
          showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç");
          return;
        }
        if (tempBottom < 0 || tempBottom > 50) {
          showError("‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏•‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0 ‡∏ñ‡∏∂‡∏á 50");
          return;
        }

        // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        try {
          await addRecordForBatch(appState.currentBatch.id, {
            record_time: new Date().toISOString(),
            humidity,
            temperature_top: tempTop,
            temperature_bottom: tempBottom,
          });
          closePopup();
          renderControlPanel();
        } catch (error) {
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function handleEditRecord(recordId) {
        console.log(`ACTION: Edit Record ${recordId}`);
        const record = appState.currentRecords.find((r) => r.id === recordId);
        const content = `
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</label><input class="form-control" value="${formatThaiDateTime(
              record.record_time
            )}" disabled></div>
            <div class="form-group"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</label><input id="popup-humidity" type="number" step="0.01" class="form-control" value="${
              record.humidity
            }" required></div>
            <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ö‡∏ô (¬∞C)</label><input id="popup-temp-top" type="number" step="0.01" class="form-control" value="${
              record.temperature_top
            }" required></div>
            <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏•‡πà‡∏≤‡∏á (¬∞C)</label><input id="popup-temp-bottom" type="number" step="0.01" class="form-control" value="${
              record.temperature_bottom
            }" required></div>
            <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label><input id="popup-confirm-pin" type="password" class="form-control" required></div>
            <div class="popup-actions">
                <button class="btn btn-warning" onclick="confirmEditRecord(${recordId})">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        showPopup("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", content, "popup-edit");
      }

      async function confirmEditRecord(recordId) {
        const humidity = parseFloat(
          document.getElementById("popup-humidity").value
        );
        const tempTop = parseFloat(
          document.getElementById("popup-temp-top").value
        );
        const tempBottom = parseFloat(
          document.getElementById("popup-temp-bottom").value
        );
        const pin = document.getElementById("popup-confirm-pin").value;
        if (pin !== ACTION_CONFIRM_PIN) {
          showError("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }
        try {
          await updateRecord(recordId, {
            humidity,
            temperature_top: tempTop,
            temperature_bottom: tempBottom,
          });
          closePopup();
          renderControlPanel();
        } catch (error) {
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function handleDeleteRecord(recordId) {
        console.log(`ACTION: Delete Record ${recordId}`);
        const record = appState.currentRecords.find((r) => r.id === recordId);
        const content = `
            <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</label><input class="form-control" value="${formatThaiDateTime(
              record.record_time
            )}" disabled></div>
            <div class="form-group"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</label><input class="form-control" value="${
              record.humidity
            }" disabled></div>
            <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏ö‡∏ô (¬∞C)</label><input class="form-control" value="${
              record.temperature_top
            }" disabled></div>
            <div class="form-group"><label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏î‡∏•‡∏°‡∏•‡πà‡∏≤‡∏á (¬∞C)</label><input class="form-control" value="${
              record.temperature_bottom
            }" disabled></div>
            <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label><input id="popup-confirm-pin" type="password" class="form-control" required></div>
            <div class="popup-actions">
                <button class="btn btn-danger" onclick="confirmDeleteRecord(${recordId})">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button class="btn btn-secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        showPopup("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", content, "popup-delete");
      }

      async function confirmDeleteRecord(recordId) {
        const pin = document.getElementById("popup-confirm-pin").value;
        if (pin !== ACTION_CONFIRM_PIN) {
          showError("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }
        try {
          await deleteRecord(recordId);
          closePopup();
          renderControlPanel();
        } catch (error) {
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`);
        }
      }

      function goToHistoryPage(page) {
        appState.historyPage = page;
        renderHistory();
      }

      // ========================================
      // EVENT LISTENERS
      // ========================================
      document.addEventListener("DOMContentLoaded", () => {
        console.log("SYSTEM: DOM Content Loaded. Initializing app...");
        registerServiceWorker();
        registerWebAppManifest();

        // Page 0
        document
          .getElementById("login-form")
          .addEventListener("submit", handleLogin);

        // Page 1
        document
          .getElementById("btn-logout")
          .addEventListener("click", handleLogout);
        document
          .getElementById("btn-view-history")
          .addEventListener("click", () => {
            showPage(3);
            renderHistory();
          });
        document
          .getElementById("btn-refresh-dashboard")
          .addEventListener("click", renderDashboard);

        // Page 2
        document
          .getElementById("btn-back-to-dashboard")
          .addEventListener("click", () => showPage(1));
        document
          .getElementById("btn-add-record")
          .addEventListener("click", handleAddRecord);

        // Page 3
        document
          .getElementById("btn-back-to-dashboard-from-history")
          .addEventListener("click", () => showPage(1));
        document
          .getElementById("btn-apply-filters")
          .addEventListener("click", () => {
            appState.historyFilters = {
              dryer: document.getElementById("filter-dryer").value,
              riceType: document.getElementById("filter-rice-type").value,
              storage: document.getElementById("filter-storage").value,
            };
            appState.historyPage = 1;
            renderHistory();
          });

        // Popup backdrop click to close
        document
          .getElementById("popup-backdrop")
          .addEventListener("click", (e) => {
            if (e.target.id === "popup-backdrop") {
              closePopup();
            }
          });

        console.log("SYSTEM: App initialization complete.");
      });
    </script>
  </body>
</html>
